<link rel="import" href="compose.html">
<link rel="import" href="nav.html">
<link rel="import" href="board.html">
<link rel="import" href="config.html">
<link rel="import" href="session.html">
<link rel="import" href="notify.html">

<template>
  <style media="screen">
    :host {
      display: block;
      position: relative;
      height: 100vh;
      width: 100vw;
    }
    #main {
      position: absolute;
      top: 50px;
      bottom: 0;
      width: 100%;
    }
  </style>

  <content select="#error"></content>
  <x-compose></x-compose>
  <x-nav></x-nav>
  <div id="main"></div>
  <x-notify></x-notify>
</template>

<script type="text/javascript">
  (function() {
    "use strict";

    var template = document.currentScript.ownerDocument.querySelector('template');

    class App extends XElement {
      createdCallback() {
        this.createShadowRoot().appendChild(document.importNode(template.content, true));

        this.handleActions([
          'openCompose', 'openComposeForReply', 'openComposeForRetweet',
          'refreshBoard', 'switchView'
        ]);

        // TODO: enable this
        // document.store.updateAllAccounts();

        // init view
        window.onpopstate = (event) => { this.loadView(event.state); };
        this.loadView(window.location);
      }

      // First time loading
      loadView(location) {
        console.log('[app] loadView', location);
        if (!location) {
          location = window.location;
        }
        switch(location.hash) {
          case '#accounts': {
            this.switchSession();
            break;
          }
          case '#settings': {
            this.switchConfig();
            break;
          }
          default: {
            document.account = null;
            var accounts = document.store.getAllAccounts();
            var screen_names = Object.keys(accounts);
            if ($.isDefined(screen_names) && screen_names && screen_names.length > 0) {
              var screen_name;
              // try parse from url
              if (location.hash.startsWith('#@')) {
                screen_name = location.hash.substr(2);
                console.log('[app] active account from url', screen_name);
                if (screen_name in accounts) {
                  this.switchBoard(accounts[screen_name]);
                  return;
                } else {
                  console.log('[app] last active account is not valid', screen_name, screen_names);
                }
              }

              // try load from store
              screen_name = document.store.getLastActiveAccount();
              console.log('[app] active account from store', screen_name);
              if (screen_name in accounts) {
                this.switchView('board', accounts[screen_name]);
              } else {
                console.log('[app] last active account is not valid', screen_name, screen_names);
                // fallback, use first account
                screen_name = screen_names[0];
                this.switchView('board', accounts[screen_name]);
              }
            } else {
              console.log('[app] no speficified account, go to sessions');
              this.switchSession();
            }
          }
        }
      }

      // Switch view after initialization
      switchView(view) {
        var method_name, title, url, args = Array.from(arguments).slice(1);
        console.log('[app] switchView', view, args, window.location);

        switch(view) {
          case 'board': {
            method_name = 'switchBoard';
            var screen_name = args[0].screen_name;
            title = `@${screen_name}`;
            url = `#@${screen_name}`;
            break;
          }
          case 'config': {
            method_name = 'switchConfig';
            title = 'Settings';
            url = '#settings';
            break;
          }
          case 'session': {
            method_name = 'switchSession';
            title = 'Accounts';
            url = '#accounts';
            break;
          }
          default: {
            console.error('[app] switchView: unknown view', view, args);
            Notify.error(`[app] switchView: unknown view: ${view}`);
            return;
          }
        }
        window.history.pushState({
          hash: url,
          account: document.account,
        }, title, url);
        this[method_name].apply(this, args);
      }

      openCompose() {
        this.$('x-compose').show();
      }

      openComposeForReply(tweet) {
        this.$('x-compose').openComposeForReply(tweet);
      }

      openComposeForRetweet(tweet) {
        this.$('x-compose').openComposeForRetweet(tweet);
      }

      refreshBoard() {
        this.$('#main x-board').refresh();
      }

      switchBoard(account) {
        console.log('switchBoard', account && account.screen_name);
        document.account = account;
        document.store.saveLastActiveAccount(account);

        var config = document.store.getConfig(account);
        if (!$.isDefined(config) || Object.keys(config).length === 0) {
          console.log('switchBoard: config is empty, switch to config view.');
          Notify.info('You need to setup config first.');
          this.switchView('config');
        } else {
          this.switchLoading();
          document.store.getTwitterClient(account)
            .fetch('account_verifyCredentials')
            .then(() => {
              this.updateView('x-board', true /* pass_elem_to_nav */);
            })
            .catch(() => {
              Notify.error('Your credential may outdated!');
            });
        }
      }

      switchConfig() {
        console.log('switchConfig');
        this.updateView('x-config');
      }

      switchSession() {
        document.account = null;
        this.updateView('x-session');
      }

      switchLoading() {
        this.updateView('content').setAttribute('select', '#loading');
      }

      updateView(elem_name, pass_elem_to_nav) {
        console.log(`[updateView] ${elem_name}`);
        $.removeAllChildren(this.$('#main'));
        var $elem = document.createElement(elem_name);
        this.$('#main').appendChild($elem);
        this.$('x-nav').updateNav(pass_elem_to_nav ? $elem : undefined);
        return $elem;
      }
    }

    document.registerElement("x-app", App);
  })();
</script>
