<link rel="import" href="compose.html">
<link rel="import" href="nav.html">
<link rel="import" href="board.html">
<link rel="import" href="config.html">
<link rel="import" href="session.html">

<template>
  <style media="screen">
    :host {
      display: block;
      position: relative;
      height: 100vh;
      width: 100vw;
    }
    #main {
      position: absolute;
      top: 50px;
      bottom: 0;
      width: 100%;
    }
  </style>

  <content select="#error"></content>
  <x-compose></x-compose>
  <x-nav></x-nav>
  <div id="main"></div>
</template>

<script type="text/javascript">
  (function() {
    "use strict";

    var template = document.currentScript.ownerDocument.querySelector('template');

    class App extends HTMLElement {
      createdCallback() {
        this.createShadowRoot().appendChild(document.importNode(template.content, true));

        this.$compose = this.shadowRoot.querySelector('x-compose');
        this.$nav = this.shadowRoot.querySelector('x-nav');
        this.$main = this.shadowRoot.querySelector('#main');

        this.handleActions([
          'openCompose', 'openComposeForReply', 'openComposeForRetweet',
          'refreshBoard', 'switchBoard', 'switchConfig', 'switchSession'
        ]);

        // TODO: enable this
        // document.store.updateAllAccounts();

        // init view
        // TODO: support anchor to jump to according view
        document.account = null;
        var accounts = document.store.getAllAccounts();
        var screen_names = Object.keys(accounts);
        if ($.isDefined(screen_names) && screen_names && screen_names.length > 0) {
          var screen_name = document.store.getLastActiveAccount();
          if (!(screen_name in accounts)) {
            console.log('[init] last active account is not valid', screen_name, screen_names);
            screen_name = screen_names[0];
          }
          this.switchBoard(accounts[screen_name]);
        } else {
          this.switchSession();
        }
      }

      openCompose(args) {
        this.$compose.show(args);
      }

      openComposeForReply(tweet) {
        this.$compose.openComposeForReply(tweet);
      }

      openComposeForRetweet(tweet) {
        this.$compose.openComposeForRetweet(tweet);
      }

      refreshBoard() {
        this.$main.querySelector('x-board').refresh();
      }

      switchBoard(account) {
        console.log('switchBoard', account && account.screen_name);
        // document.URL = `#@${account.screen_name}`;
        document.account = account;
        document.store.saveLastActiveAccount(account);
        var config = document.store.getConfig(account);
        if (!$.isDefined(config) || Object.keys(config).length === 0) {
          console.log('switchBoard: log is empty, switch to config');
          this.switchConfig();
        } else {
          $.removeAllChildren(this.$main);
          var board = document.createElement('x-board');
          this.$main.appendChild(board);
          this.$nav.updateNav(board);
        }
      }

      switchConfig() {
        console.log('switchConfig');
        // document.URL = '#config';
        $.removeAllChildren(this.$main);
        var config = document.createElement('x-config');
        this.$main.appendChild(config);
        this.$nav.updateNav();
      }

      switchSession() {
        console.log('switchSession');
        // document.URL = '#session';
        document.account = null;
        $.removeAllChildren(this.$main);
        var $session = document.createElement('x-session');
        this.$main.appendChild($session);
        this.$nav.updateNav();
      }
    }

    document.registerElement("x-app", App);
  })();
</script>
