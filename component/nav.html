<template id="nav">
  <style media="screen">
    nav {
      height: 50px;
      padding: 0 20px;
      background-color: #fefefe;
      box-shadow: #eee 0px 3px 5px;
      position: relative;
      z-index: 100;
    }
    .logo {
      line-height: 50px;
      font-size: 30px;
      font-weight: bold;
      color: #424d54;
    }
    .control-panel {
      float: right;
      height: 30px;
      line-height: 30px;
    }
    a {
      display: inline-block;
      text-decoration: none;
      white-space: nowrap;
      font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;;
      color: #555;
      padding: 0 0.5em;
    }
    a:hover {
      color: #4C91DB;
    }
    a.menu {
      line-height: 48px;
      border-bottom: 3px solid rgba(0, 0, 0, 0);;
    }
    a.menu:hover {
      border-bottom: 3px solid #4C91DB;
    }

    /* Accounts */
    .account-list-dropdown .account-list-container {
      display: none;
    }
    .account-list-dropdown:hover .account-list-container {
      display: block;
    }
    .account-list-dropdown {
      display: inline-block;
      position: relative;
    }
    .account-list-container {
      position: absolute;
      z-index: 500;
      top: 100%;
      right: 0;
      min-width: 150px;
      background: white;
      border-radius: 3px;
      border: 1px solid rgba(0, 0, 0, 0.15);;
      box-shadow: rgba(0, 0, 0, 0.18) 0 3px 3px;
    }

    #account-list {
      list-style-type: none;
      margin: 0;
      padding: 0;
    }
    .account-item:hover {
      background-color: #eee;
    }
    .account-item a {
      width: 100%;
      padding: 5px 10px;
    }
    .account-item .avatar {
      height: 16px;
    }
  </style>

  <nav>
    <span class="logo">Coolol</span>
    <span class="control-panel">
      <a href="#" class="menu" id="refresh-board">Refresh</a>
      <a href="#" class="menu" id="open-compose">Compose</a>
      <a href="#" class="menu" id="switch-config">Setting</a>
      <span class="account-list-dropdown">
        <a href="#" class="menu dropdown-target" id="switch-session">Accounts</a>
        <div class="account-list-container">
          <ul id="account-list"></ul>
          <a href="#" id="account-manage">Manage accounts</a>
        </div>
      </span>
    </span>
  </nav>
</template>

<template id="account">
  <li class="account-item">
    <a href="#">
      <img class="avatar" />
      <span class="name"></span>
    </a>
  </li>
</template>

<script type="text/javascript">
  (function () {
    "use strict";

    var $$$nav = document.currentScript.ownerDocument.querySelector('template#nav').content;
    var $$$account = document.currentScript.ownerDocument.querySelector('template#account').content;

    class Nav extends HTMLElement {
      createdCallback() {
        this.createShadowRoot().appendChild(document.importNode($$$nav, true));

        this.$refresh_board = this.shadowRoot.querySelector('#refresh-board');
        this.$open_compose = this.shadowRoot.querySelector('#open-compose');
        this.$switch_config = this.shadowRoot.querySelector('#switch-config');
        this.$switch_session = this.shadowRoot.querySelector('#account-manage');

        this.$account_list = this.shadowRoot.querySelector('#account-list');

        ['open_compose', 'switch_config', 'switch_session']
        .forEach((buttonName) => {
          this[`$${buttonName}`].addEventListener('click', (event) => {
            event.preventDefault();
            console.log('nav trigger', $.camelize(buttonName));
            this.trigger($.camelize(buttonName));
          });
        });

        this.updateAccountList();
        document.store.registerAccounts(this.updateAccountList.bind(this));
      }

      beInBoardView(toShow, board) {
        if (toShow) {
          this.$open_compose.style.visibility = "visible";
          this.$refresh_board.style.visibility = "visible";
          this.$refresh_board.addEventListener('click', board.refresh.bind(board));
        } else {
          this.$open_compose.style.visibility = "hidden";
          this.$refresh_board.style.visibility = "hidden";
        }
      }

      updateAccountList() {
        $.removeAllChild(this.$account_list);
        var accounts = document.store.getAccounts();
        for (var screen_name in accounts) {
          var account = accounts[screen_name];
          var $li = document.importNode($$$account, true);
          $li.querySelector('a').href = `#${account.screen_name}`;
          if (account.profile_image_url) {
            $li.querySelector('.avatar').src = account.profile_image_url;
          }
          $li.querySelector('.name').textContent = account.name;
          $li.querySelector('.account-item').handle('click', () => {
            console.log('li click', account.screen_name, screen_name);
            this.trigger('switchBoard', account);
          });
          console.log('list account item', $li, account.screen_name);
          this.$account_list.appendChild($li);
        }
      }
    }

    document.registerElement('x-nav', Nav);
  })();
</script>
