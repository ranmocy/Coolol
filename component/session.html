<link rel="import" href="session-accounts.html">

<template id="session">
  <style media="screen">
    :host {
      display: block;
      width: 500px;
      margin: 50px auto;
    }
  </style>

  <div id="add">Add new account</div>

  <div id="login">
    <div>
      Press
      <button type="button" id="auth">Auth</button>
      button to authorize on Twitter.
    </div>
    <div id="auth-info">
      Or manually open the url:
      <a href="" id="auth-url" target="_blank"></a>
    </div>
    <div>
      Copy the pin code from Twitter to verify:
      <input type="text" id="pin-code" value="">
      <button type="button" id="verify">Verify</button>
    </div>
  </div>

  <x-session-accounts></x-session-accounts>
</template>

<script type="text/javascript">
  (function () {
    "use strict";

    var $$$session = document.currentScript.ownerDocument.querySelector('template#session').content;

    class Session extends HTMLElement {
      createdCallback() {
        this.createShadowRoot().appendChild(document.importNode($$$session, true));

        this.$accounts = this.shadowRoot.querySelector('x-session-accounts');

        this.$add = this.shadowRoot.querySelector('#add');
        this.$auth = this.shadowRoot.querySelector('#auth');
        this.$auth_url = this.shadowRoot.querySelector('#auth-url');
        this.$pinCode = this.shadowRoot.querySelector('#pin-code');
        this.$verify = this.shadowRoot.querySelector('#verify');

        this.$auth.handle('click', this.auth.bind(this));
        this.$verify.handle('click', this.verify.bind(this));
      }

      auth() {
        this.current_client = new Twitter();
        this.current_client.auth((auth_url) => {
          this.$auth_url.textContent = auth_url;
          this.$auth_url.href = auth_url;
          window.codebird_auth = window.open(auth_url);
        });
        return this;
      }

      verify() {
        this.current_client.verify(this.$pinCode.value, (reply) => {
          if (!reply || !reply.user_id) {
            console.error('[session] verify account failed!', reply);
            return;
          }
          var account = {
            user_id: reply.user_id,
            screen_name: reply.screen_name,
            name: reply.name,
            token: reply.oauth_token,
            token_secret: reply.oauth_token_secret
          };
          document.store.saveTwitterClient(account, this.current_client);
          document.store.updateAccount(account);
        });
        return this;
      }
    }

    document.registerElement("x-session", Session);
  })();
</script>
