<template id="tweet">
  <style>
    :host {
      display: block;
    }
    #container {
      padding: 0.5em 1em;
    }
    #m-status {
      color: #888;
    }
    #m-creator {
      color: green;
    }
    #m-body {
      color: black;
    }
    .m-quoted, .m-reply {
      border: 1px #eee solid;
    }
    #m-body a{
      /*color: #4C91DB;*/
      color: #377ac3;
      text-decoration: none;
    }
  </style>

  <div id="container">
    <div id="m-status"></div>
    <div id="m-creator"></div>
    <div id="m-body">
      <div id="m-text"></div>
    </div>
  </div>
</template>

<template id="creator">
  <style media="screen">
    .avatar {
      height: 16px;
    }
  </style>

  <img class="avatar" />
  <span class="name"></span>
  <span class="handle">
    (<span class="screen-name"></span>)
  </span>
</template>

<script type="text/javascript">
  (function () {
    "use strict";

    var template = document.currentScript.ownerDocument.querySelector('template#tweet');
    var $$$creator = document.currentScript.ownerDocument.querySelector('template#creator');
    $$$creator.find = $$$creator.content.querySelector.bind($$$creator.content);

    class Tweet extends HTMLElement {
      createdCallback() {
        this.createShadowRoot().appendChild(document.importNode(template.content, true));
        this.$text = this.shadowRoot.querySelector('#m-text');

        this.tweet = null;
      }

      get(prop) {
        return this.shadowRoot.querySelector(`#m-${prop}`);
      }

      setCreator(user) {
        $$$creator.find('.avatar').src = user.profile_image_url_https;
        $$$creator.find('.name').textContent = user.name;
        $$$creator.find('.screen-name').textContent = user.screen_name;

        var $container = this.get('creator');
        $.removeAllChild($container);
        $container.appendChild(document.importNode($$$creator.content, true));
        return this;
      }

      setText(text) {
        var obj = this.tweet.entities;
        var entities = Object.keys(obj).reduce((all, key) => {
          return all.concat(obj[key]);
        }, []);
        this.$text.innerHTML = twttr.txt.autoLink(text, {urlEntities: entities});
        return this;
      }

      setData(tweet) {
        this.tweet = tweet;
        console.log('tweet', tweet);
        if (false && tweet.reply_to) {
          // it's a reply tweet
        } else if (tweet.retweeted_status) {
          // it's a retweeted tweet
          var retweet = tweet.retweeted_status;
          this.get('status').textContent = `${tweet.user.name}(${tweet.user.screen_name}) retweeted`;
          this.setCreator(retweet.user);
          this.setText(retweet.text);
        } else if (tweet.is_quote_status) {
          // it's a quoted tweet
          this.setCreator(tweet.user);
          this.setText(tweet.text);
          var original_tweet = document.createElement('x-tweet');
          original_tweet.className = "m-quoted";
          original_tweet.setData(tweet.quoted_status);
          this.get('body').appendChild(original_tweet);
        } else {
          this.setCreator(tweet.user);
          this.setText(tweet.text);
        }

        return this;
      }
    }

    // Tweet.extends = 'div';
    document.registerElement("x-tweet", Tweet);
  })();
</script>
