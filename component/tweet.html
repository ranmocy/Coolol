<template id="tweet">
  <style>
    :host {
      display: block;
    }
    #m-container {
      padding: 0.5em 1em;
    }
    #m-reply, #m-retweeted {
      color: #888;
    }
    #m-creator {
      color: green;
    }
    #m-body {
      color: black;
    }
    #m-body a{
      color: #377ac3;
      text-decoration: none;
    }

    #m-control {
      display: none;
      list-style: none;
      margin: 0;
      padding: 0;
      position: absolute;
      right: 0;
    }
    #m-control li.control-button {
      display: inline-block;
      cursor: pointer;
    }

    .avatar {
      height: 16px;
    }

    /* media */
    #m-media {
      white-space: nowrap;
      width: 400px;
      overflow-x: auto;
      overflow-y: hidden;
    }
    #m-media img {
      height: 200px;
      margin-left: 1em;
    }
  </style>

  <div id="m-container">
    <ul id="m-control">
      <li class="control-button" id="m-reply-button">Reply</li>
      <li class="control-button" id="m-retweet-button">Retweet</li>
      <li class="control-button" id="m-fav-button">Fav</li>
    </ul>
    <div id="m-retweeted"></div>
    <div id="m-reply"></div>
    <div id="m-creator"></div>
    <div id="m-body">
      <div id="m-text"></div>
      <div id="m-media"></div>
    </div>
  </div>
</template>

<template id="reply">
  <span class="reply-to">In reply to:</span>
  <span class="name"></span>
  <span class="handle">
    (<span class="screen-name"></span>)
  </span>
</template>

<template id="retweeted">
  <img class="avatar" />
  <span class="name"></span>
  <span class="handle">
    (<span class="screen-name"></span>)
  </span>
  <span> retweeted</span>
</template>

<template id="creator">
  <img class="avatar" />
  <span class="name"></span>
  <span class="handle">
    (<span class="screen-name"></span>)
  </span>
</template>


<script type="text/javascript">
  (function () {
    "use strict";

    var $$$tweet = document.currentScript.ownerDocument.querySelector('template#tweet');
    var $$$retweeted = document.currentScript.ownerDocument.querySelector('template#retweeted');
    $$$retweeted.find = $$$retweeted.content.querySelector.bind($$$retweeted.content);
    var $$$reply = document.currentScript.ownerDocument.querySelector('template#reply');
    $$$reply.find = $$$reply.content.querySelector.bind($$$reply.content);
    var $$$creator = document.currentScript.ownerDocument.querySelector('template#creator');
    $$$creator.find = $$$creator.content.querySelector.bind($$$creator.content);

    class Tweet extends HTMLElement {
      createdCallback() {
        this.createShadowRoot().appendChild(document.importNode($$$tweet.content, true));
        this.$container = this.get('container');
        this.$control = this.get('control');
        this.$text = this.get('text');
        this.$media = this.get('media');
        this.$reply = this.get('reply-button');
        this.$retweet = this.get('retweet-button');
        this.$fav = this.get('fav-button');

        this.$container.handle('mouseenter', () => { this.$control.style.display = 'block'; });
        this.$container.handle('mouseleave', () => { this.$control.style.display = 'none'; });
        this.$reply.handle('click', () => { this.trigger('openComposeForReply', this.tweet); });
        this.$retweet.handle('click', () => { this.trigger('openComposeForRetweet', this.tweet); });
        this.$fav.handle('click', () => { /* TODO: */ });

        this.tweet = null;
      }

      get(prop) {
        return this.shadowRoot.querySelector(`#m-${prop}`);
      }

      setReplyTo(tweet) {
        $$$reply.find('.screen-name').textContent = tweet.in_reply_to_screen_name;

        var $container = this.get('reply');
        $.removeAllChild($container);
        $container.appendChild(document.importNode($$$reply.content, true));
        return this;
      }

      setRetweeted(user) {
        $$$retweeted.find('.avatar').src = user.profile_image_url_https;
        $$$retweeted.find('.name').textContent = user.name;
        $$$retweeted.find('.screen-name').textContent = user.screen_name;

        var $container = this.get('retweeted');
        $.removeAllChild($container);
        $container.appendChild(document.importNode($$$retweeted.content, true));
        return this;
      }

      setCreator(user) {
        $$$creator.find('.avatar').src = user.profile_image_url_https;
        $$$creator.find('.name').textContent = user.name;
        $$$creator.find('.screen-name').textContent = user.screen_name;

        var $container = this.get('creator');
        $.removeAllChild($container);
        $container.appendChild(document.importNode($$$creator.content, true));
        return this;
      }

      setText(text) {
        var obj = this.tweet.entities;
        var entities = Object.keys(obj).reduce((all, key) => {
          return all.concat(obj[key]);
        }, []);
        this.$text.innerHTML = twttr.txt.autoLink(text, {urlEntities: entities});
        this.$text.querySelectorAll('a').forEach(function (node) {
          node.target = '_blank';
        });
        return this;
      }

      setMedia(entities, extended_entities) {
        var media = [];
        if (extended_entities && extended_entities.media) {
          media = extended_entities.media;
        } else if (entities && entities.media) {
          media = entities.media;
        }
        // console.log('media', media);
        $.removeAllChild(this.$media);
        media.forEach(function (medium) {
          var $img = document.createElement('img');
          $img.src = medium.media_url_https;
          this.$media.appendChild($img);
        }, this);
        return this;
      }

      setTweet(tweet) {
        this.setCreator(tweet.user);
        this.setText(tweet.text);
        this.setMedia(tweet.entities, tweet.extended_entities);
        return this;
      }

      setData(tweet) {
        this.tweet = tweet;
        // console.log('tweet', tweet);
        if (tweet.in_reply_to_screen_name) {
          // it's a reply tweet
          this.setTweet(tweet);
          this.setReplyTo(tweet);
        } else if (tweet.retweeted_status) {
          // it's a retweeted tweet
          this.setTweet(tweet.retweeted_status);
          this.setRetweeted(tweet.user);
        } else if (tweet.is_quote_status && $.isDefined(tweet.quoted_status) /* in case quoted tweets chain */) {
          // it's a quoted tweet
          this.setTweet(tweet);

          var original_tweet = document.createElement('x-tweet');
          original_tweet.className = "m-quoted";
          original_tweet.setData(tweet.quoted_status);
          this.get('body').appendChild(original_tweet);
        } else {
          this.setTweet(tweet);
        }

        return this;
      }
    }

    // Tweet.extends = 'div';
    document.registerElement("x-tweet", Tweet);
  })();
</script>
