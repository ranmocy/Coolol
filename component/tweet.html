<link rel="import" href="tweet-control.html">
<link rel="import" href="tweet-media.html">

<template id="tweet">
  <style>
    :host {
      display: block;
    }
    #container {
      padding: 0.5em 1em;
    }
    #reply, #retweeted {
      color: #888;
    }
    #creator {
      color: green;
    }
    #body {
      color: black;
    }
    #body a{
      color: #377ac3;
      text-decoration: none;
    }

    .avatar {
      height: 16px;
    }

    #text {
      white-space: pre-wrap;
    }

    #media {
      white-space: nowrap;
      width: 400px;
      overflow-x: auto;
      overflow-y: hidden;
    }
  </style>

  <div id="container">
    <x-tweet-control id="control"></x-tweet-control>
    <div id="retweeted"></div>
    <div id="reply"></div>
    <div id="creator"></div>
    <div id="body">
      <div id="text"></div>
      <div id="media"></div>
    </div>
  </div>
</template>

<template id="reply">
  <span class="reply-to">In reply to:</span>
  <span class="name"></span>
  <span class="handle">
    (<span class="screen-name"></span>)
  </span>
</template>

<template id="retweeted">
  <img class="avatar" />
  <span class="name"></span>
  <span class="handle">
    (<span class="screen-name"></span>)
  </span>
  <span> retweeted</span>
</template>

<template id="creator">
  <img class="avatar" />
  <span class="name"></span>
  <span class="handle">
    (<span class="screen-name"></span>)
  </span>
</template>


<script type="text/javascript">
  (function() {
    "use strict";

    var $$$tweet = document.currentScript.ownerDocument.querySelector('template#tweet').content;
    var $$$retweeted = document.currentScript.ownerDocument.querySelector('template#retweeted').content;
    var $$$reply = document.currentScript.ownerDocument.querySelector('template#reply').content;
    var $$$creator = document.currentScript.ownerDocument.querySelector('template#creator').content;

    class Tweet extends XElement {
      createdCallback() {
        this.createShadowRoot().appendChild(document.importNode($$$tweet, true));

        this.$('#container').handle('mouseenter', () => {
          this.$('#control').show();
        });
        this.$('#container').handle('mouseleave', () => {
          this.$('#control').hide();
        });

        this.tweet = null;
      }

      attachedCallback() {
        if (this.tweet == null) {
          throw new Error('tweet is null');
        }
        $.registerObjectCallback(this.tweet, this.attachedCallback.bind(this));
        this.refresh();
      }

      detachedCallback() {
        $.unregisterObjectCallback(this.tweet, this.attachedCallback.bind(this));
      }

      setTweet(tweet) {
        if (this.tweet) {
          throw new Error('tweet has already been set:' + this.tweet.tweetId);
        }
        this.tweet = tweet;
        return this;
      }

      /*private*/ setReplyTo(screen_name) {
        $$$reply.$('.screen-name').textContent = screen_name;

        var $container = this.$('#reply');
        $.removeAllChildren($container);
        $container.appendChild(document.importNode($$$reply, true));
        return this;
      }

      /*private*/ setRetweeted(user) {
        $$$retweeted.$('.avatar').src = user.profile_image_url_https;
        $$$retweeted.$('.name').textContent = user.name;
        $$$retweeted.$('.screen-name').textContent = user.screen_name;

        var $container = this.$('#retweeted');
        $.removeAllChildren($container);
        $container.appendChild(document.importNode($$$retweeted, true));
        return this;
      }

      /*private*/ setCreator(user) {
        $$$creator.$('.avatar').src = user.profile_image_url_https;
        $$$creator.$('.name').textContent = user.name;
        $$$creator.$('.screen-name').textContent = user.screen_name;

        var $container = this.$('#creator');
        $.removeAllChildren($container);
        $container.appendChild(document.importNode($$$creator, true));
        return this;
      }

      /*private*/ setText(text) {
        var entities = [];
        [this.tweet.entities, this.tweet.extended_entities].forEach((obj) => {
          if ($.isDefined(obj)) {
            entities = Object.keys(obj).reduce((all, key) => {
              return all.concat(obj[key]);
            }, entities);
          }
        });
        this.$('#text').innerHTML = twttr.txt.autoLink(text, {
          urlEntities: entities
        });
        this.$('#text').querySelectorAll('a').forEach(function(node) {
          node.target = '_blank';
        });
        return this;
      }

      /*private*/ setMedia(entities, extended_entities) {
        var media = [];
        if (extended_entities && extended_entities.media) {
          media = extended_entities.media;
        } else if (entities && entities.media) {
          media = entities.media;
        }
        $.removeAllChildren(this.$('#media'));
        media.forEach((medium) => {
          this.$('#media').appendChild(document.createElement('x-tweet-media').setMedia(medium));
        });
        return this;
      }

      /*private*/ setBody(tweet) {
        this.setCreator(tweet.user);
        this.setText(tweet.text);
        this.setMedia(tweet.entities, tweet.extended_entities);
        return this;
      }

      /*private*/ refresh() {
        let tweet = this.tweet;
        this.dataset.tweetId = tweet.id_str;
        if ($.isDefined(tweet.current_user_retweet)) {
          this.dataset.currentUserRetweetId = tweet.current_user_retweet.id_str;
        }

        // if it's a direct message
        if ($.isDirectMessage(tweet)) {
          this.setCreator(tweet.sender);
          this.setReplyTo(tweet.recipient_screen_name);
          this.setText(tweet.text);
          // no more for DM
          return this;
        }

        // Show control panel
        this.$('#control').setTweet(tweet);

        // if it's a reply tweet
        if ($.isReplyTweet(tweet)) {
          this.setReplyTo(tweet.in_reply_to_screen_name);
        }

        // if it's a quoted tweet
        if ($.isQuotedRetweet(tweet)) {
          var original_tweet = document.createElement('x-tweet');
          original_tweet.className = "quoted";
          original_tweet.setTweet(tweet.quoted_status);
          this.$('#body').appendChild(original_tweet);
        }

        // if it's a retweeted tweet
        if ($.isRetweet(tweet)) {
          this.dataset.retweetedId = tweet.retweeted_status.id_str;
          this.setRetweeted(tweet.user);
          this.setBody(tweet.retweeted_status);
        } else {
          this.setBody(tweet);
        }
      }
    }

    document.registerElement("x-tweet", Tweet);
  })();
</script>
